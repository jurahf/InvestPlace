@page "/Cash"

@using Services.DTO;
@using Services.Services.ExtendedUserService;
@using Services.Services.CashService;
@using System.ComponentModel.DataAnnotations;

@inject AuthenticationStateProvider AuthenticationStateProvider;
@inject IExtendedUserService ExtendedUserService;
@inject ICashService CashService;


<LoginWelcome>

    <div class="margin-top-50"></div>

    <div class="row">
        <div class="col col-2 offset-1 text-center">
            <img class="" src="/images/icon-cash.png" alt="cash"/>
            <h4 class="text-red text-center margin-top-20">КОШЕЛЁК</h4>
        </div>

        <div class="col col-6 offset-3">

            <div class="row">
                <div class="col col-12">
                    <!-- баланс -->
                    <h4 class="inline">Баланс: </h4><h2 class="inline">@(cash?.Summ ?? 0)</h2><h4 class="inline"> руб</h4>
                    <br/>
                    @*<h4 class="inline">Бонусы: </h4><h2 class="inline">@(cash?.BonusSumm ?? 0)</h2><h4 class="inline"> руб</h4>*@
                </div>
            </div>

            <div class="row margin-top-120">
                <div class="col col-12">
                    <!-- вывод денег -->
                    <button class="btn btn-primary" @onclick="OutCashClick">Вывод денег</button>
                    
                    <div class="row margin-top-20 @(outCashActivated ? "" : "hidden")">
                        <EditForm Model="outputCashArgs" OnValidSubmit="ValidOutputCash">
                            <DataAnnotationsValidator />
                            <ValidationSummary />
                            <div class="col col-12">
                                <label class="label">Введите, какую сумму хотите вывести</label>
                                <InputNumber class="form-control" @bind-Value="outputCashArgs.Summ"></InputNumber>
                            </div>

                            <div class="col col-12 margin-top-20">
                                <button class="btn btn-secondary">Вывести</button>
                                <h6 class="text-danger">@errorText</h6>
                                <h6 class="text-success">@successText</h6>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>

            <div class="row margin-top-20">
                <div class="col col-12">
                    <!-- проверить реквизиты -->
                    <a class="text-red" href="/ManageAccount">Проверить банковские реквизиты</a>
                </div>
            </div>
        </div>
    </div>


</LoginWelcome>




@code {
    [CascadingParameter]
    protected ExtendedUserDto user { get; set; }

    private CashDto cash = null;

    private bool outCashActivated = false;

    private OutputCashArgs outputCashArgs { get; set; }
    private string errorText = "";
    private string successText = "";


    protected override void OnInitialized()
    {
        cash = FindUserCash(user);
        outputCashArgs = new OutputCashArgs();
    }

    private CashDto FindUserCash(ExtendedUserDto user)
    {
        return user?.Cash;
    }

    private void OutCashClick()
    {
        outCashActivated = !outCashActivated;
    }


    private void ValidOutputCash()
    {
        try
        {
            errorText = "";
            successText = "";
            CashService.CreateOutputOperationRequest(user, outputCashArgs.Summ);
            successText = "Заявка на вывод денег успешно сформирована!";
            this.StateHasChanged();
        }
        catch (Exception ex)
        {
            errorText = ex.Message;
        }
    }


    //////////////////////////////////////////////////////////////////////

    public class OutputCashArgs
    {
        [Required(ErrorMessage = "Сумма должна быть указана")]
        [Range(1.0, 2_000_000.0, ErrorMessage = "Сумма должна быть числом от 1 до 2 000 000")]
        public decimal Summ { get; set; }
    }
}
