@page "/Lot/{id:int}"

@using Services.DTO;
@using Services.Services.ExtendedUserService;
@using Services.Services.BasketService;

@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider;
@inject Services.Services.LotService.ILotService lotService
@inject IExtendedUserService ExtendedUserService;
@inject IBasketService BasketService;



<div class="row">
    <div class="col col-6">

        <!-- картинка и разбивка по пазлам -->
        <div class="row">
            <div class="col col-12">
                <ImageWithHover MainImage="@editedLot.ImageLink" HoverImage="/images/puzzle-net.png" ShowHover="@showNet">
                </ImageWithHover>
            </div>
        </div>

        <!-- купить пазл, цена пазла, сколько уже куплено -->
        <div class="row margin-top-10">
            <div class="col col-4">
                <button class="btn btn-primary" @onclick="Buy">Купить пазл</button>
                <h6 class="text-danger">@((MarkupString)buyErrorText)</h6>
            </div>

            <div class="col col-4">
                <h5 class="text-red">@editedLot.PuzzlePrice руб</h5>
            </div>

            <div class="col col-4">
                <button @onclick="ShowNet" class="lot-edit-count-btn">
                    <div class="lot-edit-count">@editedLot.PuzzleCount</div>
                </button>
            </div>
        </div>
    </div>

    <!-- название, описание, ссылка -->
    <!-- цена -->
    <div class="col col-6">

        <div class="row">
            <div class="col col-12">
                <h4 class="text-red">@editedLot.Name</h4>
            </div>
        </div>

        <div class="row">
            <div class="col col-12">
                @editedLot.Description
            </div>
        </div>

        <div class="row">
            <div class="col col-12">
                <a href="@editedLot.SourceLink">@editedLot.SourceLink</a>
            </div>
        </div>

        <div class="row">
            <div class="col col-12">
                <h3>@editedLot.Price</h3>
            </div>
        </div>

    </div>
</div>





@code {
    [Parameter]
    public int Id { get; set; }

    [CascadingParameter]
    public EventCallback BasketCountChange { get; set; }

    private bool showNet = false;
    protected string buyErrorText = "";
    protected LotDto editedLot = new LotDto();

    protected override void OnInitialized()
    {
        editedLot = lotService.GetById(Id);
    }

    private void ShowNet()
    {
        showNet = !showNet;
    }

    private void Buy()
    {
        buyErrorText = "";

        // проверить, авторизован, или нет
        ExtendedUserDto user = FindUser().Result;
        if (user == null)
        {
            buyErrorText = "Для покупки необходимо выполнить <a href='/Account/Login'>вход</a>";
            return;
        }

        try
        {
            // добавить товар пользователю
            BasketDto basket = BasketService.AddToBasket(user, editedLot);
            BasketCountChange.InvokeAsync(null);
        }
        catch (Exception ex)
        {
            buyErrorText = ex.Message; // TODO: лучше возвращать специальный объект с результатом операции
        }
    }


    private async Task<ExtendedUserDto> FindUser()
    {
        ExtendedUserDto result = null;
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            result = ExtendedUserService.GetByEmail(user.Identity.Name);
        }

        return result;
    }



}